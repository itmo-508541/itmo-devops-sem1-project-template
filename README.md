# Финальный проект 1 семестра

REST API сервис для загрузки и выгрузки данных о ценах

Задание реализовано на сложном уровне:

* Логика работы Go-приложения реализована на 100%
* Скрипт `prepare.sh` загружает зависимости Go
* Скрипт `run.sh` создаёт таблицы в PostgreSQL и запускает Web-сервер
* Скрипт `test.sh` запускает тесты всех трёх уровней сложности
* После успешного выполнения тестов запускается сборка [Docker-образа](https://hub.docker.com/repository/docker/itmo508541/itmo-devops-sem1-project) и его загрузка в Docker Hub
* Далее происходит создание виртуальной машины в Yandex.Cloud (по необходимости), деплой и запуск приложения.

Ссылка на последнюю рабочую версию проекта находится под описанием репозитория, автоматически обновляется после каждого успешного деплоя.

## Требования к системе

Для запуска приложения:

* **OS**: Linux
* **Docker**: 20.10+
* **Docker Compose**

Для разработки (дополнительно):

* **Go**: 1.24+
* **Golangci-lint**: [последняя версия](https://golangci-lint.run/docs/welcome/install/)
* **Make**

## Установка и запуск

После клонирования репозитория приложение может быть запущено через Docker Compose:

* `docker compose up --build`

Второй вариант запуска:

* `make deps` - перед началом разработки необходимо запустить скачивание зависимостей.
* `docker compose up -d postgres` - запуск в Docker Compose только PostgreSQL в фоне, будет доступен на 5432 порту
* `make migrate` - внесение изменений в структуру БД, SQL-запросы миграций находятся в директории `internal/app/migrations/schema`
* `make start-server` - запуск Web-сервера, будет доступен на 8080 порту

Дополнительная настройка приложения не требуется, но возможна путём создания файла `.env.local` и добавления в этот файл переменных окружения, перекрывая значения по умолчанию из файла `.env`

* также можно установить имя хоста сервера БД в переменной `APP_DB_HOST`

## Тестирование API

Для ручного тестирования приложения можно открыть в браузере ссылку http://localhost:8080/

* с этой страницы можно загрузить ZIP- или TAR-файл
* а также задать параметры поиска и скачать данные в ZIP-архиве или просмотреть текст CSV (не скачивая файл).
* директория `sample_data` содержит ZIP- и TAR-архивы для загрузки.

Приложение успешно проходит все три уровня автоматического тестирования. Скрипты можно запускать в любом порядке:

```
./scripts/tests.sh 1
./scripts/tests.sh 2
./scripts/tests.sh 3
```

## Проверка качества кода и Unit-тестирование

```
make lint test
```

## Структура базы данных

Таблица **prices** содержит все валидные данные, всех попыток загрузки в процессе работы приложения:

* временная таблица
* очищается при старте приложения

| **Имя поля** | **Тип**          | **Описание**                   | **Пример**                           |
|:------------:|:----------------:|:------------------------------:|:------------------------------------:|
| uuid         | TEXT PRIMARY KEY | UUID записи                    | 22cacaac-f1d4-43ba-a736-eb480a2029b5 |
| id           | INTEGER          | Колонка id в CSV               | 3                                    |
| name         | TEXT             | Колонка name в CSV             | Coffee Maker                         |
| category     | TEXT             | Колонка category в CSV         | Appliances                           |
| price        | DECIMAL(10, 2)   | Колонка price в CSV            | 59.99                                |
| create_date  | DATE             | Колонка create_date в CSV      | 2024-01-03                           |
| group_uuid   | TEXT             | UUID порции загруженных данных | 5bd26bde-a75e-47b0-81a2-6a114f8dc9c5 |

Таблица **reports** содержит валидные данные из последней загрузки архива:

* очищается и обновляется в процессе работы эндпоинта `POST /api/v0/prices`
* эндпоинт `GET /api/v0/prices` делает выборки именно из этой таблицы

| **Имя поля** | **Тип**          | **Описание**                   | **Пример**                           |
|:------------:|:----------------:|:------------------------------:|:------------------------------------:|
| uuid         | TEXT PRIMARY KEY | UUID записи                    | 536010ed-b2e7-4513-a641-f618c99d53d9 |
| id           | INTEGER          | Колонка id в CSV               | 5                                    |
| name         | TEXT             | Колонка name в CSV             | Gaming Mouse                         |
| category     | TEXT             | Колонка category в CSV         | Electronics                          |
| price        | DECIMAL(10, 2)   | Колонка price в CSV            | 89.99                                |
| create_date  | DATE             | Колонка create_date в CSV      | 2024-01-20                           |

## Контакты

* Telegram: [@Cshmuch](https://t.me/Cshmuch)
* Email: andrey@mindubaev.ru (cshmuch@mail.ru)
